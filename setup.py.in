import os
from setuptools import setup, find_packages
from setuptools.command.develop import develop


def _get_scripts(base_path="."):
    # Returns the list of scripts in the bin directory.
    # Ignores .pyc files and the zensocket binary file.
    # Running 'pip install -e .' re-installs these scripts to /opt/zenoss/bin.
    bin_path = os.path.join(base_path, "bin")
    return [
        os.path.join(dirpath, name)
        for dirpath, _, filenames in os.walk(bin_path)
        for name in (
            n for n in filenames
            if not n.endswith(".pyc") and n != "zensocket"
        )
    ]


class ZenDevelopCommand(develop):
    """Used to override the 'develop' command to provide custom pth file."""

    _nspkg_tmpl = (
        "import sys, types, os",
        "zh = os.environ.get('ZENHOME', '/opt/zenoss')",
        "p = os.path.join(zh, *%(pth)r)",
        "m = sys.modules.setdefault(%(pkg)r, types.ModuleType(%(pkg)r))",
        "mp = m.__dict__.setdefault('__path__', [])",
        "(p not in mp) and mp.append(p)",
    )


setup(
    name="Zenoss",
    version="%VERSION%",
    description="Zenoss Core",
    author="Zenoss, Inc.",
    author_email="dev@zenoss.com",
    url="https://www.zenoss.com",
    license="",
    packages=find_packages(exclude=("bdd*", "*.migrate/tests*")),
    package_dir={"": "."},
    namespace_packages=["Products"],
    include_package_data=True,
    zip_safe=False,
    install_requires=[],
    python_requires="<3.0",
    scripts=_get_scripts(),
    cmdclass={
        "develop": ZenDevelopCommand,
    },
)
